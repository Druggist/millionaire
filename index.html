<!doctype html> 
<html lang="en"> 
<head> 
	<meta charset="UTF-8" />
	<title>Millionaire</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script type="text/javascript" src="js/phaser/build/phaser.js"></script>
	<link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.6.0/pure-min.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body>
<div class="nextLevelMenu hidden ">
	<div class="pure-g">
		<div class="pure-u-1-3">
			<div class="element">
				<img src="assets/images/hospital_tier5.png">
				<span id="hospitalCost">99999$</span>
				<button class="pure-button pure-button-disabled" id="buyHospital">Buy</button>
			</div>
		</div>
		<div class="pure-u-1-3">
			<div class="element">
				<img src="assets/images/armory_tier5.png">
				<span id="armoryCost">99999$</span>
				<button class="pure-button pure-button-disabled" id="buyArmory">Buy</button>
			</div>	
		</div>
		<div class="pure-u-1-3">
			<div class="element">
				<img src="assets/images/bank_tier5.png">
				<span id="bankCost">99999$</span>
				<button class="pure-button pure-button-disabled" id="buyBank">Buy</button>
			</div>
	</div>
	<button class="button-xlarge pure-button" id="nextLevelBtn">Next level</button>
</div>


<script type="text/javascript" src="https://code.jquery.com/jquery-1.12.3.min.js"></script>
<script type="text/javascript">

var game = new Phaser.Game(window.innerWidth, window.innerHeight , Phaser.AUTO, '', { preload: preload, create: create, update: update });
var cursors;
var character;
var platforms;
var ground;
var hearts;
var coins;
var ai;
var coin;
var ai2;
var lives;

var money = 0;
var hospitalLevel = 0;
var armoryLevel = 0;
var bankLevel = 0;
var killed = 0;
var toKill = 10;
var killedText;
var livesCount = 3;
var levelText = "";
var lastLeft;
var coinPower = 1;
var ais = [];

$("#nextLevelBtn").click(function(){startNewLevel()});
$("#buyHospital").click(function(){buyHospitalUpgrade()});
$("#buyArmory").click(function(){buyArmoryUpgrade()});
$("#buyBank").click(function(){buyBankUpgrade()});

function startNewLevel(){
	levelUp();
	$(".nextLevelMenu").addClass("hidden");
}

function showNextLevelMenu(){
	$(".nextLevelMenu").removeClass("hidden");
	$("#hospitalCost").text((hospitalLevel + 1) * 10000 + "$");
	$("#armoryCost").text((armoryLevel + 1) * 10000 + "$");
	$("#bankCost").text((bankLevel + 1) * 10000 + "$");
	if((hospitalLevel + 1) * 10000 > money) $("#buyHospital").addClass("pure-button-disabled");
	else $("#buyHospital").removeClass("pure-button-disabled");
	if((armoryLevel + 1) * 10000 > money) $("#buyArmory").addClass("pure-button-disabled");
	else $("#buyArmory").removeClass("pure-button-disabled");
	if((bankLevel + 1) * 10000 > money) $("#buyBank").addClass("pure-button-disabled");
	else $("#buyBank").removeClass("pure-button-disabled");
}

function buyHospitalUpgrade(){
	if((hospitalLevel + 1) * 10000 <= money){
		money -= (hospitalLevel + 1) * 10000;
		hospitalLevel++;
		livesCount++;
		renderHearts();
		showNextLevelMenu();
	}
}

function buyArmoryUpgrade(){
	if((armoryLevel + 1) * 10000 <= money){
		money -= (armoryLevel + 1) * 10000;
		armoryLevel++;
		coinPower++;
		showNextLevelMenu();
	}
}

function buyBankUpgrade(){
	if((bankLevel + 1) * 10000 <= money){
		money -= (bankLevel + 1) * 10000;
		bankLevel++;
		showNextLevelMenu();
	}
}

function preload() {
	game.stage.backgroundColor = '#fff';
	game.load.image('background', 'assets/images/bg.png');
	game.load.image('ground', 'assets/images/street_bottom.png');
	game.load.image('live', 'assets/images/live.png');
	game.load.image('coin', 'assets/images/money.png');
	game.load.image('hospital1', 'assets/images/hospital_tier1.png');
	game.load.image('hospital2', 'assets/images/hospital_tier2.png');
	game.load.image('hospital3', 'assets/images/hospital_tier3.png');
	game.load.image('hospital4', 'assets/images/hospital_tier4.png');
	game.load.image('hospital5', 'assets/images/hospital_tier5.png');
	game.load.image('armory1', 'assets/images/armory_tier1.png');
	game.load.image('armory2', 'assets/images/armory_tier2.png');
	game.load.image('armory3', 'assets/images/armory_tier3.png');
	game.load.image('armory4', 'assets/images/armory_tier4.png');
	game.load.image('armory5', 'assets/images/armory_tier5.png');
	game.load.image('bank1', 'assets/images/bank_tier1.png');
	game.load.image('bank2', 'assets/images/bank_tier2.png');
	game.load.image('bank3', 'assets/images/bank_tier3.png');
	game.load.image('bank4', 'assets/images/bank_tier4.png');
	game.load.image('bank5', 'assets/images/bank_tie.r5png');
	game.load.spritesheet('ai', 'assets/sprites/ai.png', 80, 80);
	game.load.spritesheet('character', 'assets/sprites/player.png', 80, 80);
}

function create() {

	levelUpKey = game.input.keyboard.addKey(Phaser.Keyboard.Z);
	shootKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);

	game.physics.startSystem(Phaser.Physics.ARCADE);

	var bg = game.add.sprite(0, 0, 'background');
	bg.height = game.height;
	bg.width = game.width;
	bg.smoothed = false;

	coins = game.add.group();
	coins.enableBody = true;


	lives = game.add.group();

	renderHearts(lives);

	platforms = game.add.group();
    platforms.enableBody = true;
	ground = platforms.create(0, game.world.height - 50, 'ground');
	ground.scale.setTo(2, 2);
	ground.body.immovable = true;
	ground.physicsBodyType = Phaser.Physics.ARCADE;

	character = game.add.sprite(game.width/2,game.height-300,'character');
	character.animations.add('right', [13, 14], 12, true);
	character.animations.add('left', [29, 28], 12, true);
	character.animations.add('rJump',[2, 3], true);
	character.animations.add('lJump',[17, 18], true);
	character.animations.add('lIdle', [15], true);
	character.animations.add('rIdle', [0], true);
	character.animations.add('rFall', [5], true);
	character.animations.add('lFall', [20], true);
	character.animations.add('rOnAir', [4], true);
	character.animations.add('lOnAir', [19], true);
	character.animations.add('lShoot', [21, 22, 23, 24], 20, true);
	character.animations.add('rShoot', [6, 7, 8, 9], 20, true);

	//ais = game.add.group();
	//game.physics.arcade.enable(ai);
	for(var i = 0; i < toKill; i++){
		ai = game.add.sprite(game.width-80, game.height-300, 'ai');
		game.physics.arcade.enable(ai);
		ai.physicsBodyType = Phaser.Physics.ARCADE;
		ai.body.bounce.y = 0;
		ai.body.gravity.y = 500;
		ai.body.collideWorldBounds = true;
		ai.height = 160;
		ai.width = 160;
		ai.health = 5;
		ai.lastLeft = false;
		ais[i] = ai;
		i++;
		ai = game.add.sprite(80, game.height-300, 'ai');
		game.physics.arcade.enable(ai);
		ai.physicsBodyType = Phaser.Physics.ARCADE;
		ai.body.bounce.y = 0;
		ai.body.gravity.y = 500;
		ai.body.collideWorldBounds = true;
		ai.height = 160;
		ai.width = 160;
		ai.health = 5;
		ai.lastLeft = false;
		ais[i] = ai;

	}

	game.physics.arcade.enable(character);
	character.physicsBodyType = Phaser.Physics.ARCADE;

    character.body.bounce.y = 0;
    character.body.gravity.y = 300;
    character.body.collideWorldBounds = true;
    character.height = 160;
    character.width = 160;


    levelText = game.add.text(16, 10, 'Level ' + toKill/10, { fontSize: '32px', fill: '#000' });
    killedText = game.add.text(16, 40, 'To kill: '+ killed + "/" + toKill, { fontSize: '32px', fill: '#000' });
}

function update() {

	game.physics.arcade.collide(character, platforms);
	game.physics.arcade.collide(ais, platforms);
	game.physics.arcade.collide(ais, character);
	game.physics.arcade.overlap(ais, coins, getShot, null, this);

	character.body.velocity.x = 0;

	cursors = game.input.keyboard.createCursorKeys();
	shootKey.onDown.add(shoot, this);

	updateAis(ais);
	if(cursors.up.isDown && character.body.touching.down){
		if(lastLeft)
			character.animations.play('lJump');
		else
			character.animations.play('rJump');
		character.body.velocity.y = -350;
	}
	if(cursors.right.isDown){
		character.animations.play('right');
		character.body.velocity.x = 100;
		lastLeft = false;
	}
	if(cursors.left.isDown){
		character.animations.play('left');
		character.body.velocity.x = -100;
		lastLeft = true;
	}
	if(!cursors.left.isDown && !cursors.right.isDown && !cursors.up.isDown && !shootKey.isDown)
	{
		if(lastLeft)
			character.animations.play('lFall');
		else
			character.animations.play('rFall');
	}
	if(!cursors.left.isDown && !cursors.right.isDown && !cursors.up.isDown && !shootKey.isDown && character.body.touching.down){
		if(lastLeft)
			character.animations.play('lIdle');
		else
			character.animations.play('rIdle');
	}
	if(levelUpKey.isDown){
		levelUp();
	}
	//game.physics.arcade.overlap(character, ground, isTouchingGround, null, this)
}

function levelUp(){
	toKill += 10;
	updateText();
}

function updateAis(ais){
	ais.forEach(function(ai){
		if(ai.x > character.x && !ai.body.touching.left){
			//ai.animations.play('left');
			ai.body.velocity.x = -50;
			lastLeft = true;
		}
		else if(ai.x < character.x && !ai.body.touching.right){
			//ai.animations.play('right');
			ai.body.velocity.x = 50;
			lastLeft = false;
		}else{
			//ai.animations.play('attack');
			//ai.body.velocity.x = 0;
			updateLives(hearts-1)
		}
	});
}

function updateText(){
	levelText.text = 'Level ' + toKill/10;
    killedText.text = 'To kill: '+ killed + "/" + toKill;
}

function updateLives(_livesCount){
	livesCount = _livesCount;
	renderHearts();

}

function renderHearts(){
	for(var i = 1; i <= livesCount; i++){
		var live = lives.create(game.width-(50*i)-10, 10, 'live');
		live.width = 50;
		live.height = 50;
	}
}

function getShot(ai, coin){
	//ai.kill();
	coin.kill();
	console.log(ai.health);
	ai.health -= coinPower;
	if(ai.health <= 0){
		ai.kill();
		killed+=1;
		updateText();
		if(killed >= toKill)
			showNextLevelMenu();
	}
}
function shoot(){
	if(lastLeft){
		character.animations.play('lShoot');
		coin = coins.create(character.x - 20, character.y + character.width/2, 'coin');
	}else{
		character.animations.play('rShoot');
		coin = coins.create(character.x + 170, character.y + character.width/2, 'coin');
	}

	//coin = coins.create(character.x + 20, character.y + character.width/2, 'coin');
	coin.width = 20;
	coin.height = 20;

	if(lastLeft)
		coin.body.gravity.x = -300;
	else
		coin.body.gravity.x = 300;
}

</script>

</body>
</html>